const characterData = [
  {
    name: "Wolfchan",
    categories: [
      {
        name: "Hands",
        options: [
          "clear.png",
          "handsw1.png",
          "handsw2.png",
          "handsw3.png",
          "handsw4.png",
          "handsw5.png",
          "handsw6.png",
          "handsw7.png",
        ],
      },
      {
        name: "Headpieces",
        options: [
          "clear.png",
          "head1.png",
          "head2.png",
          "head3.png",
          "head4.png",
          "head5.png",
          "head6.png",
          "head7.png",
          "head8.png",
          "head9.png",
          "head10.png",
          "head11.png",
          "head12.png",
          "head13.png",
          "head14.png",
          "head15.png",
          "head16.png",
          "head17.png",
          "head18.png",
          "head19.png",
          "head20.png",
        ],
      },
      //bread and cake have top & bottom
      {
        name: "Clothes",
        options: [
          "clear.png",
          "cloth1.png",
          "cloth2.png",
          "cloth3.png",
          "cloth4.png",
          "cloth5.png",
          "cloth6.png",
        ],
      },
      {
        name: "Eyes",
        options: [
          "clear.png",
          "eyew1.png",
          "eyew2.png",
          "eyew3.png",
          "eyew4.png",
        ],
      },
      {
        name: "Mouths",
        options: [
          "clear.png",
          "mouthw1.png",
          "mouthw2.png",
          "mouthw3.png",
          "mouthw4.png",
          "mouthw5.png",
          "mouthw6.png",
          "mouthw7.png",
        ],
      },
      {
        name: "Bg",
        options: [
          "clear.png",
          "bg1.png",
          "bg2.png",
          "bg3.png",
          "bg4.png",
          "bg5.png",
        ],
      },
    ],
  },
  {
    name: "Leebit",
    categories: [
      {
        name: "Hands",
        options: [
          "clear.png",
          "handsl1.png",
          "handsl2.png",
          "handsl3.png",
          "handsl4.png",
          "handsl5.png",
          "handsl6.png",
          "handsl7.png",
        ],
      },
      {
        name: "Headpieces",
        options: [
          "clear.png",
          "head1.png",
          "head2.png",
          "head3.png",
          "head4.png",
          "head5.png",
          "head6.png",
          "head7.png",
          "head8.png",
          "head9.png",
          "head10.png",
          "head11.png",
          "head12.png",
          "head13.png",
          "head14.png",
          "head15.png",
          "head16.png",
          "head17.png",
          "head18.png",
          "head19.png",
          "head20.png",
        ],
      },
      //bread and cake have top & bottom
      {
        name: "Clothes",
        options: [
          "clear.png",
          "cloth1.png",
          "cloth2.png",
          "cloth3.png",
          "cloth4.png",
          "cloth5.png",
          "cloth6.png",
        ],
      },
      {
        name: "Eyes",
        options: [
          "clear.png",
          "eyel1.png",
          "eyel2.png",
          "eyel3.png",
          "eyel4.png",
        ],
      },
      {
        name: "Mouths",
        options: [
          "clear.png",
          "mouthl1.png",
          "mouthl2.png",
          "mouthl3.png",
          "mouthl4.png",
          "mouthl5.png",
          "mouthl6.png",
          "mouthl7.png",
        ],
      },
      {
        name: "Bg",
        options: [
          "clear.png",
          "bg1.png",
          "bg2.png",
          "bg3.png",
          "bg4.png",
          "bg5.png",
        ],
      },
    ],
  },
  {
    name: "Dwaekki",
    categories: [
      {
        name: "Hands",
        options: [
          "clear.png",
          "handsd1.png",
          "handsd2.png",
          "handsd3.png",
          "handsd4.png",
          "handsd5.png",
          "handsd6.png",
          "handsd7.png",
        ],
      },
      {
        name: "Headpieces",
        options: [
          "clear.png",
          "head1.png",
          "head2.png",
          "head3.png",
          "head4.png",
          "head5.png",
          "head6.png",
          "head7.png",
          "head8.png",
          "head9.png",
          "head10.png",
          "head11.png",
          "head12.png",
          "head13.png",
          "head14.png",
          "head15.png",
          "head16.png",
          "head17.png",
          "head18.png",
          "head19.png",
          "head20.png",
        ],
      },
      //bread and cake have top & bottom
      {
        name: "Clothes",
        options: [
          "clear.png",
          "cloth1.png",
          "cloth2.png",
          "cloth3.png",
          "cloth4.png",
          "cloth5.png",
          "cloth6.png",
        ],
      },
      {
        name: "Eyes",
        options: [
          "clear.png",
          "eyed1.png",
          "eyed2.png",
          "eyed3.png",
          "eyed4.png",
        ],
      },
      {
        name: "Mouths",
        options: [
          "clear.png",
          "mouthd1.png",
          "mouthd2.png",
          "mouthd3.png",
          "mouthd4.png",
          "mouthd5.png",
          "mouthd6.png",
          "mouthd7.png",
        ],
      },
      {
        name: "Bg",
        options: [
          "clear.png",
          "bg1.png",
          "bg2.png",
          "bg3.png",
          "bg4.png",
          "bg5.png",
        ],
      },
    ],
  },
  {
    name: "Jiniret",
    categories: [
      {
        name: "Hands",
        options: [
          "clear.png",
          "handsj1.png",
          "handsj2.png",
          "handsj3.png",
          "handsj4.png",
          "handsj5.png",
          "handsj6.png",
          "handsj7.png",
        ],
      },
      {
        name: "Headpieces",
        options: [
          "clear.png",
          "head1.png",
          "head2.png",
          "head3.png",
          "head4.png",
          "head5.png",
          "head6.png",
          "head7.png",
          "head8.png",
          "head9.png",
          "head10.png",
          "head11.png",
          "head12.png",
          "head13.png",
          "head14.png",
          "head15.png",
          "head16.png",
          "head17.png",
          "head18.png",
          "head19.png",
          "head20.png",
        ],
      },
      //bread and cake have top & bottom
      {
        name: "Clothes",
        options: [
          "clear.png",
          "cloth1.png",
          "cloth2.png",
          "cloth3.png",
          "cloth4.png",
          "cloth5.png",
          "cloth6.png",
        ],
      },
      {
        name: "Eyes",
        options: [
          "clear.png",
          "eyej1.png",
          "eyej2.png",
          "eyej3.png",
          "eyej4.png",
        ],
      },
      {
        name: "Mouths",
        options: [
          "clear.png",
          "mouthj1.png",
          "mouthj2.png",
          "mouthj3.png",
          "mouthj4.png",
          "mouthj5.png",
          "mouthj6.png",
          "mouthj7.png",
        ],
      },
      {
        name: "Bg",
        options: [
          "clear.png",
          "bg1.png",
          "bg2.png",
          "bg3.png",
          "bg4.png",
          "bg5.png",
        ],
      },
    ],
  },
  {
    name: "Hanquokka",
    categories: [
      {
        name: "Hands",
        options: [
          "clear.png",
          "handsh1.png",
          "handsh2.png",
          "handsh3.png",
          "handsh4.png",
          "handsh5.png",
          "handsh6.png",
          "handsh7.png",
        ],
      },
      {
        name: "Headpieces",
        options: [
          "clear.png",
          "head1.png",
          "head2.png",
          "head3.png",
          "head4.png",
          "head5.png",
          "head6.png",
          "head7.png",
          "head8.png",
          "head9.png",
          "head10.png",
          "head11.png",
          "head12.png",
          "head13.png",
          "head14.png",
          "head15.png",
          "head16.png",
          "head17.png",
          "head18.png",
          "head19.png",
          "head20.png",
        ],
      },
      //bread and cake have top & bottom
      {
        name: "Clothes",
        options: [
          "clear.png",
          "cloth1.png",
          "cloth2.png",
          "cloth3.png",
          "cloth4.png",
          "cloth5.png",
          "cloth6.png",
        ],
      },
      {
        name: "Eyes",
        options: [
          "clear.png",
          "eyeh1.png",
          "eyeh2.png",
          "eyeh3.png",
          "eyeh4.png",
        ],
      },
      {
        name: "Mouths",
        options: [
          "clear.png",
          "mouthh1.png",
          "mouthh2.png",
          "mouthh3.png",
          "mouthh4.png",
          "mouthh5.png",
          "mouthh6.png",
          "mouthh7.png",
        ],
      },
      {
        name: "Bg",
        options: [
          "clear.png",
          "bg1.png",
          "bg2.png",
          "bg3.png",
          "bg4.png",
          "bg5.png",
        ],
      },
    ],
  },
  {
    name: "Bbokari",
    categories: [
      {
        name: "Hands",
        options: [
          "clear.png",
          "handsb1.png",
          "handsb2.png",
          "handsb3.png",
          "handsb4.png",
          "handsb5.png",
          "handsb6.png",
          "handsb7.png",
        ],
      },
      {
        name: "Headpieces",
        options: [
          "clear.png",
          "head1.png",
          "head2.png",
          "head3.png",
          "head4.png",
          "head5.png",
          "head6.png",
          "head7.png",
          "head8.png",
          "head9.png",
          "head10.png",
          "head11.png",
          "head12.png",
          "head13.png",
          "head14.png",
          "head15.png",
          "head16.png",
          "head17.png",
          "head18.png",
          "head19.png",
          "head20.png",
        ],
      },
      //bread and cake have top & bottom
      {
        name: "Clothes",
        options: [
          "clear.png",
          "cloth1.png",
          "cloth2.png",
          "cloth3.png",
          "cloth4.png",
          "cloth5.png",
          "cloth6.png",
        ],
      },
      {
        name: "Eyes",
        options: [
          "clear.png",
          "eyeb1.png",
          "eyeb2.png",
          "eyeb3.png",
          "eyeb4.png",
        ],
      },
      {
        name: "Mouths",
        options: [
          "clear.png",
          "mouthb1.png",
          "mouthb2.png",
          "mouthb3.png",
          "mouthb4.png",
          "mouthb5.png",
          "mouthb6.png",
          "mouthb7.png",
        ],
      },
      {
        name: "Bg",
        options: [
          "clear.png",
          "bg1.png",
          "bg2.png",
          "bg3.png",
          "bg4.png",
          "bg5.png",
        ],
      },
    ],
  },
  {
    name: "Puppym",
    categories: [
      {
        name: "Hands",
        options: [
          "clear.png",
          "handsp1.png",
          "handsp2.png",
          "handsp3.png",
          "handsp4.png",
          "handsp5.png",
          "handsp6.png",
          "handsp7.png",
        ],
      },
      {
        name: "Headpieces",
        options: [
          "clear.png",
          "head1.png",
          "head2.png",
          "head3.png",
          "head4.png",
          "head5.png",
          "head6.png",
          "head7.png",
          "head8.png",
          "head9.png",
          "head10.png",
          "head11.png",
          "head12.png",
          "head13.png",
          "head14.png",
          "head15.png",
          "head16.png",
          "head17.png",
          "head18.png",
          "head19.png",
          "head20.png",
        ],
      },
      //bread and cake have top & bottom
      {
        name: "Clothes",
        options: [
          "clear.png",
          "cloth1.png",
          "cloth2.png",
          "cloth3.png",
          "cloth4.png",
          "cloth5.png",
          "cloth6.png",
        ],
      },
      {
        name: "Eyes",
        options: [
          "clear.png",
          "eyep1.png",
          "eyep2.png",
          "eyep3.png",
          "eyep4.png",
        ],
      },
      {
        name: "Mouths",
        options: [
          "clear.png",
          "mouthp1.png",
          "mouthp2.png",
          "mouthp3.png",
          "mouthp4.png",
          "mouthp5.png",
          "mouthp6.png",
          "mouthp7.png",
        ],
      },
      {
        name: "Bg",
        options: [
          "clear.png",
          "bg1.png",
          "bg2.png",
          "bg3.png",
          "bg4.png",
          "bg5.png",
        ],
      },
    ],
  },
  {
    name: "Foxiny",
    categories: [
      {
        name: "Hands",
        options: [
          "clear.png",
          "handsf1.png",
          "handsf2.png",
          "handsf3.png",
          "handsf4.png",
          "handsf5.png",
          "handsf6.png",
          "handsf7.png",
        ],
      },
      {
        name: "Headpieces",
        options: [
          "clear.png",
          "head2.png",
          "head3.png",
          "head4.png",
          "head5.png",
          "head6.png",
          "head7.png",
          "head8.png",
          "head9.png",
          "head10.png",
          "head11.png",
          "head12.png",
          "head13.png",
          "head14.png",
          "head15.png",
          "head16.png",
          "head17.png",
          "head18.png",
          "head19.png",
          "head20.png",
        ],
      },
      //bread and cake have top & bottom
      {
        name: "Clothes",
        options: [
          "clear.png",
          "cloth1.png",
          "cloth2.png",
          "cloth3.png",
          "cloth4.png",
          "cloth5.png",
          "cloth6.png",
        ],
      },
      {
        name: "Eyes",
        options: [
          "clear.png",
          "eyef1.png",
          "eyef2.png",
          "eyef3.png",
          "eyef4.png",
        ],
      },
      {
        name: "Mouths",
        options: [
          "clear.png",
          "mouthf1.png",
          "mouthf2.png",
          "mouthf3.png",
          "mouthf4.png",
          "mouthf5.png",
          "mouthf6.png",
          "mouthf7.png",
        ],
      },
      {
        name: "Bg",
        options: [
          "clear.png",
          "bg1.png",
          "bg2.png",
          "bg3.png",
          "bg4.png",
          "bg5.png",
        ],
      },
    ],
  },
];

const specialLayers = {
  "cloth3.png": {
    bottom: new Image(),
    top: new Image(),
  },
  "cloth6.png": {
    bottom: new Image(),
    top: new Image(),
  },
};

specialLayers["cloth3.png"].bottom.src = "./cloth3b.png";
specialLayers["cloth3.png"].top.src = "./cloth3.png";
specialLayers["cloth6.png"].bottom.src = "./cloth6b.png";
specialLayers["cloth6.png"].top.src = "./cloth6.png";

let selectedCharacter = 0;
let categories = characterData[selectedCharacter].categories;
let selectedCategory = 0;
let selections = new Array(categories.length).fill(0);
let baseCharIMG = null;
let layerImages = [];
const canvas = document.getElementById("previewCanvas");
const ctx = canvas.getContext("2d");
canvas.width = 2048;
canvas.height = 2048;

function scrollToCharacters() {
  document
    .querySelector(".character-selection")
    .scrollIntoView({ behavior: "smooth" });
}

function scrollToSelectors() {
  document
    .querySelector(".select-section")
    .scrollIntoView({ behavior: "smooth" });
}

function updateCharacter(index) {
  baseCharIMG = new Image();
  baseCharIMG.src = `./char${index + 1}.png`;
  baseCharIMG.onload = () => {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(baseCharIMG, 0, 0, canvas.width, canvas.height);
    updatePreview();
  };
}

function selectCharacter(index) {
  scrollToSelectors();
  selectedCharacter = index;
  categories = characterData[selectedCharacter].categories;
  selections = new Array(categories.length).fill(0);
  selectedCategory = 0;
  layerImages = new Array(categories.length).fill(null);
  document
    .querySelectorAll(".character-button")
    .forEach((btn) => btn.classList.remove("active"));
  document.getElementById("char" + (index + 1)).classList.add("active");
  document
    .querySelectorAll(".category-button")
    .forEach((btn) => btn.classList.remove("active"));
  document.getElementById("cat1").classList.add("active");
  updateCharacter(index);
  updateOptions();
}

function selectCategory(index) {
  selectedCategory = index;
  document
    .querySelectorAll(".category-button")
    .forEach((btn) => btn.classList.remove("active"));
  document.getElementById("cat" + (index + 1)).classList.add("active");
  updateOptions();
}

function updateOptions() {
  const optionsDiv = document.getElementById("optionSelectors");
  optionsDiv.innerHTML = "";
  categories[selectedCategory].options.forEach((option, index) => {
    const button = document.createElement("button");
    button.className = "option-button";
    button.style.backgroundImage = `url('./${option}')`;
    if (selections[selectedCategory] === index) {
      button.classList.add("selected");
    }
    button.onclick = () => selectOption(index);
    optionsDiv.appendChild(button);
  });
}

function selectOption(index) {
  selections[selectedCategory] = index;

  const optionsDiv = document.getElementById("optionSelectors");
  const buttons = optionsDiv.querySelectorAll(".option-button");
  buttons.forEach((btn, i) => btn.classList.toggle("selected", i === index));

  const layerIMG = new Image();
  layerIMG.src = `./${categories[selectedCategory].options[index]}`;

  layerIMG.onload = () => {
    layerImages[selectedCategory] = layerIMG;
    updatePreview();
  };
}

function updatePreview() {
  if (!baseCharIMG?.complete) {
    return;
  }

  ctx.clearRect(0, 0, canvas.width, canvas.height);

  const bgIndex = categories.findIndex((c) => c.name === "Bg");
  if (bgIndex >= 0 && layerImages[bgIndex]) {
    ctx.drawImage(layerImages[bgIndex], 0, 0, canvas.width, canvas.height);
  }

  const clothesIndex = categories.findIndex((c) => c.name === "Clothes");
  const clothesSelection = selections[clothesIndex];
  const clothesName = categories[clothesIndex].options[clothesSelection];
  const handsIndex = categories.findIndex((c) => c.name === "Hands");

  if (specialLayers[clothesName]?.bottom.complete) {
    ctx.drawImage(
      specialLayers[clothesName].bottom,
      0,
      0,
      canvas.width,
      canvas.height
    );
  }

  if (baseCharIMG?.complete) {
    ctx.drawImage(baseCharIMG, 0, 0, canvas.width, canvas.height);
  }

  layerImages.forEach((img, i) => {
    if (
      i !== bgIndex &&
      i !== clothesIndex &&
      i !== handsIndex &&
      img?.complete
    ) {
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
    }
  });

  const normalClothes = layerImages[clothesIndex];
  if (normalClothes?.complete) {
    ctx.drawImage(normalClothes, 0, 0, canvas.width, canvas.height);
  }
  if (specialLayers[clothesName]?.top?.complete) {
    ctx.drawImage(
      specialLayers[clothesName].top,
      0,
      0,
      canvas.width,
      canvas.height
    );
  }

  const handsLayer = layerImages[handsIndex];
  if (handsLayer?.complete) {
    ctx.drawImage(handsLayer, 0, 0, canvas.width, canvas.height);
  }
}

function finishPfp() {
  document.getElementById("popup").style.display = "flex";
  openPopup();
}

function savePfp() {
  const link = document.createElement("a");
  link.download = "skzoomii.png";
  link.href = canvas.toDataURL();
  link.click();
}

function openPopup() {
  document.getElementById("popup").style.display = "flex";
}

function closePopup() {
  document.getElementById("popup").style.display = "none";
}

selectCategory(0);
updatePreview();
