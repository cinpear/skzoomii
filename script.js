const characterData = [
  {
    name: "Wolfchan",
    categories: [
      {
        name: "Hands",
        options: [
          "clear.png",
          "handsw1.png",
          "handsw2.png",
          "handsw3.png",
          "handsw4.png",
          "handsw5.png",
          "handsw6.png",
          "handsw7.png",
        ],
      },
      {
        name: "Headpieces",
        options: [
          "clear.png",
          "head1.png",
          "head2.png",
          "head3.png",
          "head4.png",
          "head5.png",
          "head6.png",
          "head7.png",
          "head8.png",
          "head9.png",
          "head10.png",
        ],
      },
      //bread and cake have top & bottom
      {
        name: "Clothes",
        options: [
          "clear.png",
          "cloth1.png",
          "cloth2.png",
          "cloth3.png",
          "cloth4.png",
          "cloth5.png",
          "cloth6.png",
        ],
      },
      {
        name: "Hoodies",
        options: [
          "clear.png",
          "hoodie1.png",
          "hoodie2.png",
          "hoodie3.png",
          "hoodie4.png",
          "hoodie5.png",
          "hoodie6.png",
          "hoodie7.png",
          "hoodie8.png",
          "hoodie9.png",
          "hoodie10.png",
        ],
      },
      {
        name: "Eyes",
        options: ["clear.png", "eye1.png", "eye2.png", "eye3.png", "eye4.png"],
      },
      {
        name: "Mouths",
        options: [
          "clear.png",
          "mouth1.png",
          "mouth2.png",
          "mouth3.png",
          "mouth4.png",
          "mouth5.png",
          "mouth6.png",
          "mouth7.png",
        ],
      },
      { name: "Bg", options: ["clear.png", "bg1.png", "bg2.png", "bg3.png"] },
    ],
  },
  {
    name: "Leebit",
    categories: [
      {
        name: "Hands",
        options: [
          "handsl1.png",
          "handsl2.png",
          "handsl3.png",
          "handsl4.png",
          "clear.png",
        ],
      },
      {
        name: "Headpieces",
        options: [
          "head1.png",
          "head2.png",
          "head3.png",
          "head4.png",
          "head5.png",
          "head6.png",
          "head7.png",
          "head8.png",
          "head9.png",
          "head10.png",
          "head11.png",
          "head12.png",
          "head13.png",
          "head14.png",
          "head15.png",
          "head16.png",
          "head17.png",
          "head18.png",
          "head19.png",
          "head20.png",
          "clear.png",
        ],
      },
      //bread and cake have top & bottom
      {
        name: "Clothes",
        options: [
          "cloth1.png",
          "cloth2.png",
          "cloth3.png",
          "cloth4.png",
          "cloth5.png",
          "cloth6.png",
          "clear.png",
        ],
      },
      /*
      {
        name: "Hoodies",
        options: [
          "hoodie1.png",
          "hoodie2.png",
          "hoodie3.png",
          "hoodie4.png",
          "hoodie5.png",
          "hoodie6.png",
          "hoodie7.png",
          "hoodie8.png",
          "hoodie9.png",
          "hoodie10.png",
          "clear.png",
        ],
      },
      */
      {
        name: "Faces",
        options: [
          "facel1.png",
          "facel2.png",
          "facel3.png",
          "facel4.png",
          "facel5.png",
          "facel6.png",
          "facel7.png",
          "facel8.png",
          "facel9.png",
          "facel10.png",
          "facel11.png",
          "clear.png",
        ],
      },
      { name: "Bg", options: ["bg1.png", "bg2.png", "bg3.png", "clear.png"] },
    ],
  },
  {
    name: "Dwaekki",
    categories: [
      {
        name: "Hands",
        options: [
          "handsd1.png",
          "handsd2.png",
          "handsd3.png",
          "handsd4.png",
          "clear.png",
        ],
      },
      {
        name: "Headpieces",
        options: [
          "head1.png",
          "head2.png",
          "head3.png",
          "head4.png",
          "head5.png",
          "head6.png",
          "head7.png",
          "head8.png",
          "head9.png",
          "head10.png",
          "clear.png",
        ],
      },
      //bread and cake have top & bottom
      {
        name: "Clothes",
        options: [
          "cloth1.png",
          "cloth2.png",
          "cloth3.png",
          "cloth4.png",
          "cloth5.png",
          "cloth6.png",
          "clear.png",
        ],
      },
      {
        name: "Hoodies",
        options: [
          "hoodie1.png",
          "hoodie2.png",
          "hoodie3.png",
          "hoodie4.png",
          "hoodie5.png",
          "hoodie6.png",
          "hoodie7.png",
          "hoodie8.png",
          "hoodie9.png",
          "hoodie10.png",
          "clear.png",
        ],
      },
      {
        name: "Eyes",
        options: ["clear.png", "eye1.png", "eye2.png", "eye3.png", "eye4.png"],
      },
      {
        name: "Mouths",
        options: [
          "clear.png",
          "mouth1.png",
          "mouth2.png",
          "mouth3.png",
          "mouth4.png",
          "mouth5.png",
          "mouth6.png",
          "mouth7.png",
        ],
      },
      { name: "Bg", options: ["bg1.png", "bg2.png", "bg3.png", "clear.png"] },
    ],
  },
  {
    name: "Jiniret",
    categories: [
      {
        name: "Hands",
        options: [
          "handsj1.png",
          "handsj2.png",
          "handsj3.png",
          "handsj4.png",
          "clear.png",
        ],
      },
      {
        name: "Headpieces",
        options: [
          "head1.png",
          "head2.png",
          "head3.png",
          "head4.png",
          "head5.png",
          "head6.png",
          "head7.png",
          "head8.png",
          "head9.png",
          "head10.png",
          "clear.png",
        ],
      },
      //bread and cake have top & bottom
      {
        name: "Clothes",
        options: [
          "cloth1.png",
          "cloth2.png",
          "cloth3.png",
          "cloth4.png",
          "cloth5.png",
          "cloth6.png",
          "clear.png",
        ],
      },
      {
        name: "Hoodies",
        options: [
          "hoodie1.png",
          "hoodie2.png",
          "hoodie3.png",
          "hoodie4.png",
          "hoodie5.png",
          "hoodie6.png",
          "hoodie7.png",
          "hoodie8.png",
          "hoodie9.png",
          "hoodie10.png",
          "clear.png",
        ],
      },
      {
        name: "Faces",
        options: [
          "facej1.png",
          "facej2.png",
          "facej3.png",
          "facej4.png",
          "facej5.png",
          "facej6.png",
          "facej7.png",
          "facej8.png",
          "facej9.png",
          "facej10.png",
          "facej11.png",
          "clear.png",
        ],
      },
      { name: "Bg", options: ["bg1.png", "bg2.png", "bg3.png", "clear.png"] },
    ],
  },
  {
    name: "Hanquokka",
    categories: [
      {
        name: "Hands",
        options: [
          "handsh1.png",
          "handsh2.png",
          "handsh3.png",
          "handsh4.png",
          "clear.png",
        ],
      },
      {
        name: "Headpieces",
        options: [
          "head1.png",
          "head2.png",
          "head3.png",
          "head4.png",
          "head5.png",
          "head6.png",
          "head7.png",
          "head8.png",
          "head9.png",
          "head10.png",
          "clear.png",
        ],
      },
      //bread and cake have top & bottom
      {
        name: "Clothes",
        options: [
          "cloth1.png",
          "cloth2.png",
          "cloth3.png",
          "cloth4.png",
          "cloth5.png",
          "cloth6.png",
          "clear.png",
        ],
      },
      {
        name: "Hoodies",
        options: [
          "hoodie1.png",
          "hoodie2.png",
          "hoodie3.png",
          "hoodie4.png",
          "hoodie5.png",
          "hoodie6.png",
          "hoodie7.png",
          "hoodie8.png",
          "hoodie9.png",
          "hoodie10.png",
          "clear.png",
        ],
      },
      {
        name: "Eyes",
        options: ["clear.png", "eye1.png", "eye2.png", "eye3.png", "eye4.png"],
      },
      { name: "Bg", options: ["bg1.png", "bg2.png", "bg3.png", "clear.png"] },
    ],
  },
  {
    name: "Bbokari",
    categories: [
      {
        name: "Hands",
        options: [
          "handsb1.png",
          "handsb2.png",
          "handsb3.png",
          "handsb4.png",
          "clear.png",
        ],
      },
      {
        name: "Headpieces",
        options: [
          "head1.png",
          "head2.png",
          "head3.png",
          "head4.png",
          "head5.png",
          "head6.png",
          "head7.png",
          "head8.png",
          "head9.png",
          "head10.png",
          "clear.png",
        ],
      },
      //bread and cake have top & bottom
      {
        name: "Clothes",
        options: [
          "cloth1.png",
          "cloth2.png",
          "cloth3.png",
          "cloth4.png",
          "cloth5.png",
          "cloth6.png",
          "clear.png",
        ],
      },
      {
        name: "Hoodies",
        options: [
          "hoodie1.png",
          "hoodie2.png",
          "hoodie3.png",
          "hoodie4.png",
          "hoodie5.png",
          "hoodie6.png",
          "hoodie7.png",
          "hoodie8.png",
          "hoodie9.png",
          "hoodie10.png",
          "clear.png",
        ],
      },
      {
        name: "Faces",
        options: [
          "faceb1.png",
          "faceb2.png",
          "faceb3.png",
          "faceb4.png",
          "faceb5.png",
          "faceb6.png",
          "faceb7.png",
          "faceb8.png",
          "faceb9.png",
          "faceb10.png",
          "faceb11.png",
          "clear.png",
        ],
      },
      { name: "Bg", options: ["bg1.png", "bg2.png", "bg3.png", "clear.png"] },
    ],
  },
  {
    name: "Puppym",
    categories: [
      {
        name: "Hands",
        options: [
          "handsp1.png",
          "handsp2.png",
          "handsp3.png",
          "handsp4.png",
          "clear.png",
        ],
      },
      {
        name: "Headpieces",
        options: [
          "head1.png",
          "head2.png",
          "head3.png",
          "head4.png",
          "head5.png",
          "head6.png",
          "head7.png",
          "head8.png",
          "head9.png",
          "head10.png",
          "clear.png",
        ],
      },
      //bread and cake have top & bottom
      {
        name: "Clothes",
        options: [
          "cloth1.png",
          "cloth2.png",
          "cloth3.png",
          "cloth4.png",
          "cloth5.png",
          "cloth6.png",
          "clear.png",
        ],
      },
      {
        name: "Hoodies",
        options: [
          "hoodie1.png",
          "hoodie2.png",
          "hoodie3.png",
          "hoodie4.png",
          "hoodie5.png",
          "hoodie6.png",
          "hoodie7.png",
          "hoodie8.png",
          "hoodie9.png",
          "hoodie10.png",
          "clear.png",
        ],
      },
      {
        name: "Faces",
        options: [
          "facep1.png",
          "facep2.png",
          "facep3.png",
          "facep4.png",
          "facep5.png",
          "facep6.png",
          "facep7.png",
          "facep8.png",
          "facep9.png",
          "facep10.png",
          "facep11.png",
          "clear.png",
        ],
      },
      { name: "Bg", options: ["bg1.png", "bg2.png", "bg3.png", "clear.png"] },
    ],
  },
  {
    name: "Foxiny",
    categories: [
      {
        name: "Hands",
        options: [
          "handsf1.png",
          "handsf2.png",
          "handsf3.png",
          "handsf4.png",
          "clear.png",
        ],
      },
      {
        name: "Headpieces",
        options: [
          "head1.png",
          "head2.png",
          "head3.png",
          "head4.png",
          "head5.png",
          "head6.png",
          "head7.png",
          "head8.png",
          "head9.png",
          "head10.png",
          "clear.png",
        ],
      },
      //bread and cake have top & bottom
      {
        name: "Clothes",
        options: [
          "cloth1.png",
          "cloth2.png",
          "cloth3.png",
          "cloth4.png",
          "cloth5.png",
          "cloth6.png",
          "clear.png",
        ],
      },
      {
        name: "Hoodies",
        options: [
          "hoodie1.png",
          "hoodie2.png",
          "hoodie3.png",
          "hoodie4.png",
          "hoodie5.png",
          "hoodie6.png",
          "hoodie7.png",
          "hoodie8.png",
          "hoodie9.png",
          "hoodie10.png",
          "clear.png",
        ],
      },
      {
        name: "Faces",
        options: [
          "facef1.png",
          "facef2.png",
          "facef3.png",
          "facef4.png",
          "facef5.png",
          "facef6.png",
          "facef7.png",
          "facef8.png",
          "facef9.png",
          "facef10.png",
          "facef11.png",
          "clear.png",
        ],
      },
      { name: "Bg", options: ["bg1.png", "bg2.png", "bg3.png", "clear.png"] },
    ],
  },
];

const specialLayers = {
  "cloth3.png": {
    bottom: new Image(),
    top: new Image(),
  },
  "cloth6.png": {
    bottom: new Image(),
    top: new Image(),
  },
};

specialLayers["cloth3.png"].bottom.src = "./cloth3b.png";
specialLayers["cloth3.png"].top.src = "./cloth3.png";
specialLayers["cloth6.png"].bottom.src = "./cloth6b.png";
specialLayers["cloth6.png"].top.src = "./cloth6.png";

let selectedCharacter = 0;
let categories = characterData[selectedCharacter].categories;
let selectedCategory = 0;
let selections = new Array(categories.length).fill(0);
let baseCharIMG = null;
let layerImages = [];
const canvas = document.getElementById("previewCanvas");
const ctx = canvas.getContext("2d");
canvas.width = 2048;
canvas.height = 2048;

function scrollToCharacters() {
  document
    .querySelector(".character-selection")
    .scrollIntoView({ behavior: "smooth" });
}

function scrollToSelectors() {
  document
    .querySelector(".select-section")
    .scrollIntoView({ behavior: "smooth" });
}

function updateCharacter(index) {
  baseCharIMG = new Image();
  baseCharIMG.src = `./char${index + 1}.png`;
  baseCharIMG.onload = () => {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(baseCharIMG, 0, 0, canvas.width, canvas.height);
    updatePreview();
  };
}

function selectCharacter(index) {
  scrollToSelectors();
  selectedCharacter = index;
  categories = characterData[selectedCharacter].categories;
  selections = new Array(categories.length).fill(0);
  selectedCategory = 0;
  layerImages = new Array(categories.length).fill(null);
  document
    .querySelectorAll(".character-button")
    .forEach((btn) => btn.classList.remove("active"));
  document.getElementById("char" + (index + 1)).classList.add("active");
  document
    .querySelectorAll(".category-button")
    .forEach((btn) => btn.classList.remove("active"));
  document.getElementById("cat1").classList.add("active");
  updateCharacter(index);
  updateOptions();
}

function selectCategory(index) {
  selectedCategory = index;
  document
    .querySelectorAll(".category-button")
    .forEach((btn) => btn.classList.remove("active"));
  document.getElementById("cat" + (index + 1)).classList.add("active");
  updateOptions();
}

function updateOptions() {
  const optionsDiv = document.getElementById("optionSelectors");
  optionsDiv.innerHTML = "";
  categories[selectedCategory].options.forEach((option, index) => {
    const button = document.createElement("button");
    button.className = "option-button";
    button.style.backgroundImage = `url('./${option}')`;
    if (selections[selectedCategory] === index) {
      button.classList.add("selected");
    }
    button.onclick = () => selectOption(index);
    optionsDiv.appendChild(button);
  });
}

function selectOption(index) {
  selections[selectedCategory] = index;

  const layerIMG = new Image();
  layerIMG.src = `./${categories[selectedCategory].options[index]}`;

  layerIMG.onload = () => {
    layerImages[selectedCategory] = layerIMG;
    updatePreview();
  };
}

function updatePreview() {
  if (!baseCharIMG?.complete) {
    return;
  }

  ctx.clearRect(0, 0, canvas.width, canvas.height);

  const bgIndex = categories.findIndex((c) => c.name === "Bg");
  if (bgIndex >= 0 && layerImages[bgIndex]) {
    ctx.drawImage(layerImages[bgIndex], 0, 0, canvas.width, canvas.height);
  }

  const clothesIndex = categories.findIndex((c) => c.name === "Clothes");
  const clothesSelection = selections[clothesIndex];
  const clothesName = categories[clothesIndex].options[clothesSelection];
  const handsIndex = categories.findIndex((c) => c.name === "Hands");

  if (specialLayers[clothesName]?.bottom.complete) {
    ctx.drawImage(
      specialLayers[clothesName].bottom,
      0,
      0,
      canvas.width,
      canvas.height
    );
  }

  if (baseCharIMG?.complete) {
    ctx.drawImage(baseCharIMG, 0, 0, canvas.width, canvas.height);
  }

  layerImages.forEach((img, i) => {
    if (
      i !== bgIndex &&
      i !== clothesIndex &&
      i !== handsIndex &&
      img?.complete
    ) {
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
    }
  });

  const normalClothes = layerImages[clothesIndex];
  if (normalClothes?.complete) {
    ctx.drawImage(normalClothes, 0, 0, canvas.width, canvas.height);
  }
  if (specialLayers[clothesName]?.top?.complete) {
    ctx.drawImage(
      specialLayers[clothesName].top,
      0,
      0,
      canvas.width,
      canvas.height
    );
  }

  const handsLayer = layerImages[handsIndex];
  if (handsLayer?.complete) {
    ctx.drawImage(handsLayer, 0, 0, canvas.width, canvas.height);
  }
}

function finishPfp() {
  document.getElementById("popup").style.display = "flex";
}

function savePfp() {
  const link = document.createElement("a");
  link.download = "skzoomii.png";
  link.href = canvas.toDataURL();
  link.click();
}

selectCategory(0);
updatePreview();
